import os
import time
import requests
from config.celery import Celery
from utils import save_report

app = Celery('dynamic_tasks')
app.config_from_object('celeryconfig')

CUCKOO_API_URL = "http://localhost:8090"


@app.task
def analyze_file(file_path, reports_dir):
    task_id = submit_file(file_path)
    if not task_id:
        return None

    while True:
        status = get_task_status(task_id)
        if status == "reported":
            break
        elif status in ["pending", "running", "completed"]:
            time.sleep(30)
        else:
            return None

    report = get_report(task_id)
    if report:
        report_path = os.path.join(reports_dir, f"{os.path.basename(file_path)}_dynamic.json")
        save_report(report, report_path)
        return report_path
    return None


def submit_file(file_path):
    with open(file_path, 'rb') as f:
        files = {'file': (file_path, f)}
        response = requests.post(f"{CUCKOO_API_URL}/tasks/create/file", files=files)
        if response.status_code == 200:
            return response.json().get('task_id')
    return None


def get_task_status(task_id):
    response = requests.get(f"{CUCKOO_API_URL}/tasks/view/{task_id}")
    if response.status_code == 200:
        return response.json().get('task').get('status')
    return None


def get_report(task_id):
    response = requests.get(f"{CUCKOO_API_URL}/tasks/report/{task_id}")
    if response.status_code == 200:
        return response.json()
    return None
