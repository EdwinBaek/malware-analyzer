FROM ubuntu:20.04

# Install dependencies
RUN apt-get update && apt-get install -y \
    python3 python3-pip python3-dev \
    mongodb \
    libffi-dev libssl-dev \
    virtualbox virtualbox-ext-pack \
    tcpdump apparmor-utils \
    libcap2-bin curl \
    redis-server

# Install Cuckoo and Celery
RUN pip3 install cuckoo celery redis requests

# Create cuckoo user
RUN useradd -m -s /bin/bash cuckoo
USER cuckoo
WORKDIR /home/cuckoo

# Initialize Cuckoo
RUN cuckoo init

# Copy scripts and configuration
COPY . /home/cuckoo/

# Install Python dependencies
RUN pip3 install -r requirements.txt

# Expose necessary ports
EXPOSE 8090 2042

# Run Cuckoo and Redis
CMD service redis-server start && cuckoo rooter --sudo
