# Cuckoo Sandbox Dockerfile for PE File Analysis
FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive

# Add MongoDB repository
RUN apt-get update && apt-get install -y wget gnupg && \
    wget -qO - https://www.mongodb.org/static/pgp/server-4.4.asc | apt-key add - && \
    echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu bionic/mongodb-org/4.4 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-4.4.list

RUN apt-get update && apt-get install -y \
    python python-dev libffi-dev libssl-dev libcap2-bin curl libxml2-dev mongodb-org postgresql \
    libxslt1-dev libjpeg-dev zlib1g-dev libpq-dev tcpdump apparmor-utils yara libfuzzy-dev nano \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install pip for Python 2
RUN curl https://bootstrap.pypa.io/pip/2.7/get-pip.py --output get-pip.py && \
    python2.7 get-pip.py && \
    rm get-pip.py

RUN pip2 install --no-cache-dir pip==20.3.4 setuptools==44.1.1 wheel
RUN pip2 install --no-cache-dir ssdeep==3.4
RUN pip2 install --no-cache-dir cuckoo==2.0.7 celery==4.4.7 redis==3.5.3 requests==2.27.1 \
    ssdeep==3.4 pefile==2019.4.18 python-dotenv==0.19.2 watchdog==0.10.3

RUN setcap cap_net_raw,cap_net_admin=eip /usr/sbin/tcpdump

RUN useradd -m -s /bin/bash cuckoo

# 상위 폴더의 dataset을 참조하도록 변경
RUN mkdir -p /app/dataset && chown -R cuckoo:cuckoo /app/dataset

USER cuckoo
WORKDIR /home/cuckoo

RUN cuckoo init

COPY --chown=cuckoo:cuckoo report_sender.py /home/cuckoo/report_sender.py
COPY --chown=cuckoo:cuckoo .env /home/cuckoo/.env

VOLUME ["/app/dataset"]

CMD ["/bin/bash"]